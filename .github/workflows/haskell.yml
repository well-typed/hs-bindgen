name: Build and test
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  setup-matrix:
    name: Setup matrix
    runs-on: 'ubuntu-latest'
    timeout-minutes: 5

    outputs:
      matrix: ${{ steps.setup-matrix.outputs.matrix }}

    defaults:
      run:
        shell: bash

    steps:
    - name: üõ†Ô∏è Setup matrix (PR)
      if: ${{ github.event_name == 'pull_request' }}
      run: |
        { echo 'MATRIX_COMBINATIONS<<EOF'
          echo '{"runner": "ubuntu-latest", "ghc": "9.4", "llvm": "15"},'
          echo EOF
        } >> "$GITHUB_ENV"

    - name: üõ†Ô∏è Setup matrix (MQ, push to main)
      if: ${{ github.event_name != 'pull_request' }}
      run: |
        { echo 'MATRIX_COMBINATIONS<<EOF'
          echo '{"runner": "macos-latest"  , "ghc": "9.4", "llvm": "14"},'
          echo '{"runner": "windows-latest", "ghc": "9.4", "llvm": "14"},'
          # Vary LLVM version from 14 to 20.
          echo '{"runner": "ubuntu-latest" , "ghc": "9.4", "llvm": "14"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.4", "llvm": "16"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.4", "llvm": "18"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.4", "llvm": "20"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.4", "llvm": "21"},'
          # Vary GHC version from 9.2 to 9.12.
          echo '{"runner": "ubuntu-latest" , "ghc": "9.2", "llvm": "14"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.6", "llvm": "14"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.8", "llvm": "14"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.10", "llvm": "14"},'
          echo '{"runner": "ubuntu-latest" , "ghc": "9.12", "llvm": "14"},'
          echo EOF
        } >> "$GITHUB_ENV"

    - name: üõ†Ô∏è Setup matrix
      id: setup-matrix
      run: |
        echo $MATRIX_COMBINATIONS
        MATRIX="{\"include\":[$MATRIX_COMBINATIONS]}"
        echo $MATRIX
        {
          echo 'MATRIX<<EOF'
          echo "$MATRIX"
          echo EOF
        } >> "$GITHUB_OUTPUT"

  check-success:
    name: Check success
    runs-on: ubuntu-latest
    timeout-minutes: 5

    needs:
    - build-and-test

    defaults:
      run:
        shell: bash

    if: ${{ !cancelled() }}

    steps:
    - name: üß™ Report failure
      if: ${{ needs.build-and-test.result == 'failure' }}
      run: |
        echo "Some jobs failed"
        exit 1

    - name: üß™ Report success
      if: ${{ needs.build-and-test.result == 'success'  }}
      run: |
        echo "All jobs succeeded"
        exit 0

  build-and-test:
    name: Run (${{ matrix.runner }}, GHC${{ matrix.ghc }}, LLVM${{matrix.llvm }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45

    needs:
    - setup-matrix

    strategy:
      matrix: ${{ fromJSON(needs.setup-matrix.outputs.matrix) }}
      fail-fast: false

    env:
      # Increment this number to reset caches.
      #
      # Caches of the cabal store generally grow in size: new packages are
      # added, but never removed. Unless we start with a fresh cabal store once
      # in a while. The cache-reset-number is part of the cache key, and if it
      # is incremented, then the "Restor cache" step fails to restore a cache,
      # meaning we will start with an empty cabal store that we will then save a
      # new cache for.
      cache-reset-number: 0

    defaults:
      run:
        shell: bash

    steps:
    - name: üõ†Ô∏è Set git to use LF
      run: |
        git config --global core.autocrlf false
        git config --global core.eol lf

    - name: üõ†Ô∏è Fix git on macOS (prioritize system git over Homebrew)
      if: runner.os == 'macOS'
      run: |
        echo "/usr/bin" >> "$GITHUB_PATH"

    - name: üì• Checkout
      uses: actions/checkout@v4

    - name: (Debug) Check disk usage (init)
      run: |
        echo "--- Disk usage ---"
        df -h
        echo "--- Home directory size ---"
        du -sh $HOME

    - name: üõ†Ô∏è Setup Haskell
      id: setup-haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: 3.16

    - name: üß™ Debug (Haskell)
      run: |
        echo '### ghc --version'
        ghc --version
        echo '### ghc-pkg list'
        ghc-pkg list
        echo '### ghc --info'
        ghc --info

    - name: üõ†Ô∏è Install LLVM/Clang
      uses: ./.github/actions/setup-llvm
      with:
        version: ${{ matrix.llvm }}

    - name: (Debug) Check disk usage (after GHC and LLVM install)
      run: |
        echo "--- Disk usage ---"
        df -h
        echo "--- Home directory size ---"
        du -sh $HOME

    - name: üõ†Ô∏è cabal.project
      run: cp cabal.project.ci cabal.project

    - name: üíæ Generate Cabal plan
      run: cabal build all --dry-run

    - name: üíæ Restore cache
      id: cache-cabal-restore
      uses: actions/cache/restore@v4
      env:
        key: build-and-test-${{ env.cache-reset-number }}-${{ matrix.runner }}-ghc-${{ steps.setup-haskell.outputs.ghc-version }}-cabal-${{ steps.setup-haskell.outputs.cabal-version }}-llvm-${{ matrix.llvm }}
      with:
        path: ${{ steps.setup-haskell.outputs.cabal-store }}
        key: ${{ env.key }}-plan-${{ hashFiles('dist-newstyle/cache/plan.json') }}
        restore-keys: ${{ env.key }}-

    - name: üõ†Ô∏è Build Cabal dependencies
      run: cabal build all --only-dependencies

    - name: üèóÔ∏è Build
      run: cabal build all

    - name: (Debug) Check disk usage (after build)
      run: |
        echo "--- Disk usage ---"
        df -h
        echo "--- Home directory size ---"
        du -sh $HOME

    - name: üß™ Debug (hs-bindgen)
      run: |
        echo '### Version'
        cabal run hs-bindgen-cli -- --version
        echo '### libclang -v'
        cabal run hs-bindgen-cli -- info libclang --clang-option=-v
        echo '### Resolve (clang)'
        cabal run hs-bindgen-cli -- info resolve-header -v4 --builtin-include-dir=clang stdint.h

    - name: üß™ Test
      run: cabal test all --test-show-details=direct

    - name: üß™ Build manual (macOS)
      if: runner.os == 'macOS'
      uses: ./.github/actions/build-manual-macos

    - name: üß™ Build manual (Ubuntu)
      if: runner.os == 'Linux'
      uses: ./.github/actions/build-manual-ubuntu

    - name: üõ†Ô∏è Windows quirks - Manual requires Clang version coming with GHC
      if: ${{ startsWith(matrix.runner, 'windows') }}
      run: |
          echo '### ls "C:\tools\ghc-${{ steps.setup-haskell.outputs.ghc-version }}\mingw\bin"'
          ls "C:\tools\ghc-${{ steps.setup-haskell.outputs.ghc-version }}\mingw\bin"
          echo "C:\tools\ghc-${{ steps.setup-haskell.outputs.ghc-version }}\mingw\bin" >> "$GITHUB_PATH"

    - name: üß™ Build manual (Windows)
      if: runner.os == 'Windows'
      uses: ./.github/actions/build-manual-windows

    # Save the cache after building the project AND the manual.
    - name: üíæ Save cache
      uses: actions/cache/save@v4
      # Even save the cache, even when a previous job failed. Do not save the
      # cache when the job gets canceled.
      if: ${{ !cancelled() }}
      with:
        path: ${{ steps.setup-haskell.outputs.cabal-store }}
        key: ${{ steps.cache-cabal-restore.outputs.cache-primary-key }}
